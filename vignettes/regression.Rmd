---
title: "Vignette: Robust Survey Regression Estimation"
author: "Beat Hulliger and Tobias Schoch"
output:
    html_document:
        highlight: tango
vignette: >
  %\VignetteIndexEntry{Robust Survey Regression Estimator}
  %\VignetteEngine{knitr::rmarkdown}
  \usepackage[utf8]{inputenc}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
    collapse = TRUE,
    comment = "",
    prompt = TRUE
)
```

```{css, echo = FALSE}
.my-sidebar-orange {
    padding-left: 1.5rem;
    padding-top: 0.5rem;
    padding-bottom: 0.25rem;
    margin-top: 1.25rem;
    margin-bottom: 1.25rem;
    border: 1px solid #eee;
    border-left-width: 0.75rem;
    border-radius: .25rem;
    border-left-color: #ce5b00;
}

.my-sidebar-blue {
    padding-left: 1.5rem;
    padding-top: 0.5rem;
    padding-bottom: 0.25rem;
    margin-top: 1.25rem;
    margin-bottom: 1.25rem;
    border: 1px solid #eee;
    border-left-width: 0.75rem;
    border-radius: .25rem;
    border-left-color: #1f618d;
}
```

## Outline

The vignette is organized as follows.

 - 1 Workplace data
 - 2 Robust regression
 - References


First, we load the `robsurvey` **and** the `survey` package ([Lumley](#biblio), 2010, 2021).

```{r, eval=FALSE}
library(robsurvey, quietly = TRUE)
library(survey)
```

```{r, echo = FALSE}
library(robsurvey, quietly = TRUE)
suppressPackageStartupMessages(library(survey))
```


## 1. Workplace Data
The `workplace` sample consists of payroll data on $n=142$ workplaces or business establishments (with paid employees) in the retail sector of a Canadian province.

 - The data display similar characteristics to the original 1999 Canadian Workplace and Employee Survey (WES), however, the `workplace` data are not those collected by Statistics Canada but have been generated by [Fuller](#biblio) (2009, Example 3.1.1, Table 6.3).
 - The sampling design is stratified by industry, geographic region, and size (size is defined using estimated employment). A sample of workplaces was then drawn independently in each stratum using simple random sample without replacement (sample size is determined by Neyman allocation).

The original weights of WES were about 2200 for the stratum of small workplaces, about 750 for medium-sized, and about 35 for large workspaces. Several strata containing very large workplaces were sampled exhaustively; see [Patak et al](#biblio) (1998).

```{r}
attach(workplace)
```

The variable of interest is `payroll`, and the goal is to estimate the population total of payroll in the retail sector.

```{r}
head(workplace, 3)
```

### 1.1 Survey design object
We specify a `survey.design` object

```{r}
dn <- svydesign(ids = ~ID, strata = ~strat, fpc = ~fpc, weights = ~weight, data = workplace)
```

which appears (on print) with the following output in the console
```{r, echo = FALSE}
dn
```

### 1.2 Exploring the data

`svyplot(payroll ~ employment, dn)` of the `survey` package

Bubble plots are scatterplots with circles whose area is proportional to the sampling weight


```{r, echo = FALSE}
svyplot(payroll ~ employment, dn, inches = 0.2, xlab = "employment", ylab = "payroll")
```

### 1.3 Population model

$$\begin{equation}
payroll_i = a + b \cdot employment_i + e_i, \qquad i \in U,
\end{equation}$$
where $a,b \in \mathbb{R}$ are the regression coefficients to be estimated, and $e_i$ denotes the regression error.

# 2 Weighted Least Squares Regression

<div class="my-sidebar-orange">
<p style="color: #ce5b00;">
**IMPORTANT**
</p>
<p>
The weighted least squares estimator is **not robust**; outliers can **heavily** influence the estimates.
</p>
</div>

```{r}
m <- svyreg(payroll ~ employment, dn)
m
```

The `summary()` method can be used to extract inferential statistics.

```{r}
summary(m)
```

Other useful methods and utility functions

* `coef()` extracts the estimated coefficients
* `residuals()` extracts the residuals
* `fitted()` extracts the fitted values
* `vcov()` extracts the variance-covariance matrix of the estimated coefficients

<div class="my-sidebar-blue">
<p style="color: #1f618d;">
**Good to know.**
</p>
<p>Alternatively, linear models can be fitted by weighted least squares with the `svyglm()` function in the `survey` package. The `summary()` method for `svyglm` differs from ours insofar that it does not compute `Pr(>|t|)` but the probability under the assumption of the Gaussian distribution.
</p>
</div>


# 3 Regression *M*-estimator
In the presence of residual outliers, the weighted least squares estimator can be biased and/or inefficient as an estimator of the population regression coefficients.

*M*-Estimator with

* Huber $\psi$-function
* asymmetric Huber $\psi$-function
* Tukey biweight $\psi$-function (redescending)

```{r}
m <- svyreg_huber(payroll ~ employment, dn, k = 13, asym=T)
m
```

* tuning constant
* other arguments: failure of convergence
* asymmetric

```{r}
plot(residuals(m), robweights(m))
```

<div class="my-sidebar-blue">
<p style="color: #1f618d;">
**Good to know.**
</p>
<p>MASS `rlm(..., method = "M", wt.method = "case")`
</p>
</div>


Redescending $\psi$-function: Tukey biweight `svyreg_tukey()`


## 3.2 Regression inference
```{r}
summary(m)
```

* design-based
* model-based
* compound

# 4 Regression *GM*-estimator


---





## References {#biblio}

Chambers, R. (1986). Outlier Robust Finite Population Estimation. *Journal of the American Statistical Association* 81, pp. 1063–1069.

Fuller, W.A. (2009). *Sampling Statistics*, Jown Wiley & Sons, Hoboken (NJ).

Hulliger B (2005). Horvitz-Thompson Estimators, Robustified, in: S. Kotz (ed.), *Encyclopedia of Statistical Sciences*, volume 5, 2nd edition. John Wiley and Sons, Hoboken (NJ).

Hulliger, B (1999). Simple and robust estimators for sampling, in: *Proceedings of the Survey Research Methods Section, American Statistical Association*, pp. 54–63. American Statistical Association.

Hulliger. B. (1995). Outlier Robust Horvitz–Thompson Estimators. *Survey Methodology* 21, pp. 79–87.

Lumley, T (2021). survey: analysis of complex survey samples. R package version 4.0, URL https://CRAN.R-project.org/package=survey.

Lumley, T. (2010). Complex Surveys: A Guide to Analysis Using R: *A Guide to Analysis Using R*. John Wiley and Sons, Hoboken, NJ.
