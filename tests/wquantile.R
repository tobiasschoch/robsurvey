#==============================================================================
# wquantile: weighted quantiles 					     
# ----------------------------------------------------------------------------- 
# PROJECT  sctbase 							     
# SUBEJCT  R function and test cases  
# AUTHORS  Tobias Schoch (tobias.schoch@fhnw.ch), February 10, 2020	     
# LICENSE  GPL >= 2							     
# COMMENT  [none]							     
#==============================================================================
setwd("C:/My/C/sctbase")
dyn.load("wquantile.dll")

wquantile <- function(x, w = NULL, probs = 0.5){
   if (is.null(w)) w <- rep(1, length(x))
   stopifnot(0 <= probs, probs <= 1)
   tmp <- .C("wquantile", x = as.double(x), 
      w = as.double(w),
      n = as.integer(length(x)),
      q = as.double(probs), 
      result = as.double(numeric(1)))
      return(as.numeric(tmp$result))
}

x <- c(2, 4, 10, 8, 9, 3, 7, 5, 6, 1)

y <- c(-1.07, -0.66,  0.69,  1.91, -2.07,  0.13, -0.12, -0.42,  2.15,  0.39,  0.64)



#==============================================================================
# Test cases for the weighted median
#==============================================================================
cases <- list()
#------------------------------------------------------------------------------
# Case 1 (weighted median = 4)
cases[[1]] <- list(x = 1:5, w = c(0.15, 0.1, 0.2, 0.3, 0.25), result = 4)
#------------------------------------------------------------------------------
# Case 2 (lower weighted median = 2; upper weighted median = 3)
cases[[2]] <- list(x = 1:4, w = rep(0.25, 4), result = 2)
#------------------------------------------------------------------------------
# Case 3 (lower weighted median = 2, upper weighted median = 3)
cases[[3]] <- list(x = 1:4, w = c(0.49, 0.01, 0.25, 0.25), result = 2)
#------------------------------------------------------------------------------
# Case 4 
cases[[4]] <- list(x = 1:3, w = rep(0.1, 3), result = 2)
#------------------------------------------------------------------------------
# Case 5 
cases[[5]] <- list(x = 1:3, w = c(2, 1, 1), result = 1)
#------------------------------------------------------------------------------
# Case 6 (edge case) 
cases[[6]] <- list(x = 1:3, w = c(3, 1, 1), result = 1)
#------------------------------------------------------------------------------
# Case 7
cases[[7]] <- list(x = 1:2, w = c(1, 1), result = 1)
#------------------------------------------------------------------------------
# Case 8 (edge case) 
cases[[8]] <- list(x = c(1.3, 5.1, 2.9, 1.9, 7.4), 
   w = c(1.4, 0.9, 0.6, 1.2, 1.7), result = 2.9)
#------------------------------------------------------------------------------
# Case 9 
cases[[9]] <- list(x = c(4.2, 1.3, 7.4, 0.2, 4.6, 9.8, 5.5, 3.7), 
   w = c(0.4, 2.1, 1.1, 1.6, 0.3, 0.9, 1.2, 1.7), result = 3.7)
#------------------------------------------------------------------------------
# Case 10 (edge case) 
cases[[10]] <- list(x = c(0.1, 0.35, 0.05, 0.1, 0.15, 0.05, 0.2),
   w = c(0.1, 0.35, 0.05, 0.1, 0.15, 0.05, 0.2), result = 0.2)
#------------------------------------------------------------------------------
# Case 11 
cases[[11]] <- list(x = c(0.49, 0.36, 0.36, 0.18, 0.75, 0.33, 0.68, 0.82, 0.38, 
   0.75, 0.61, 0.02, 0.57, 0.23, 0.56, 0.03, 0.45, 0.44, 0.36, 0.92),
   w = c(0.08, 0.22, 0.79, 0.84, 0.69, 0.84, 0.08, 0.87, 0.95, 0.27, 0.9, 0.34, 
   0.75, 0.65, 0.02, 0.83, 0.32, 0.68, 0.92, 0.37), result = 0.38)
#FIXME:
#------------------------------------------------------------------------------
# Case 12 
cases[[12]] <- list(x = c(0.64, 0.95, 0.05, 0.08, 0.32, 0.25, 0.58, 0.69, 0.88, 
   0.53, 0.48, 0.58, 0.32, 0.52, 0.42, 0.69, 0.43, 0.91, 0.15, 0.27, 0.31, 0.16,
   0.56, 0.68, 0.58, 0.04, 0.51, 0.06, 0.18, 0.03),
   w = c(0.97, 0.2, 0.12, 0.01, 0.86, 0.29, 0.93, 0.96, 0.89, 0.03, 0.24, 0.56, 
   0.81, 0.97, 0.48, 0.32, 0.33, 0.22, 0.8, 0.17, 0.96, 0.75, 0.43, 0.24, 0.81, 
   0.4, 0.93, 0.43, 0.17, 0.13), result = 0.51)
#FIXME:
#------------------------------------------------------------------------------
# Case 13 
cases[[13]] <- list(x = c( 0.19, 0.14, 0.15, 0.79, 0.36, 0.13, 0.44, 0.67, 
   0.44, 0.98, 0.2, 0.11, 0.78, 0.67, 0.28, 0.29, 0.99, 0.55, 0.34, 0.36, 0.09, 
   0.13, 0.56, 0.19, 0.08, 0.46, 0.62, 0.98, 0.46, 0.37, 0.09, 0.94, 0.84, 0.64, 
   0.18, 0.64, 0.78, 0.88, 0.17, 0.28), 
   w = c( 0.67, 0.39, 0.31, 0.06, 0.93, 0.21, 0.09, 0.29, 0.78, 0.42, 0.79, 
   0.27, 0.77, 0.35, 0.11, 0.99, 0.05, 0.39, 0.34, 0.97, 0.82, 0.4, 0.09, 0.77, 
   0.28, 0.03, 0.63, 0.67, 0.1, 0.3, 0.85, 0.44, 0.66, 0.52, 0.15, 0.4, 0.82, 
   0.66, 0.21, 0.72), result = 0.36)
#FIXME:
#==============================================================================
# Test run 
#==============================================================================
all <- print(sapply(cases, function(u) identical(wquantile(u$x, u$w, 
   probs = 0.5), u$result)))
if(sum(!all) == 0){
   cat("All test cases are ok\n")
}else{
   cat("The cases:", paste0((1:length(cases))[!all], collapse = ", "), 
   "failed\n")
}



sapply(cases, function(u) wquantile(u$x, u$w, probs = 0.1))


#sapply(cases[4], function(u) wquantile(u$x, u$w, probs = 0.5))
# test <- function(cases, which){
#    tmp <- data.frame(x = cases[[which]]$x, w = cases[[which]]$w)
#    n <- nrow(tmp)
#    tmp <- tmp[order(tmp$x), ]
#    tmp$w <- tmp$w / sum(tmp$w)
#    tmp$cumsum <- cumsum(tmp$w)
#    at <- sum(tmp$cumsum < 0.5)
#    if (at == 0) at <- 1
#    print(tmp)
#    cat(paste0("median = ", tmp$x[at], "\n"))
#    cat(paste0("weight below median: ", round(sum(tmp$w[1:(at - 1)]), 2), "\n"))
#    cat(paste0("weight at median:    ", round(tmp$w[at], 2), "\n"))
#    cat(paste0("weight above median: ", round(sum(tmp$w[(at + 1):n]), 2), "\n"))
# }
#
